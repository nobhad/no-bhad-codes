<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - No Bhad Codes Client Portal</title>
    <style>
      /* Match main site: use --color-neutral-300 which is overridden in dark mode */
      html,
      body {
        background-color: var(--color-neutral-300, #e0e0e0);
        color: var(--color-dark, #333333);
        margin: 0;
        padding: 0;
      }
    </style>
    <script>
      (function () {
        try {
          const savedTheme = localStorage.getItem('theme');
          document.documentElement.setAttribute('data-theme', savedTheme || 'light');
        } catch (e) {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      })();
    </script>
    <meta name="description" content="Reset your password for the No Bhad Codes Client Portal" />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#e0e0e0" />
    <script type="module" src="/src/portal.ts"></script>
  </head>
  <body data-page="client-portal" data-view="reset-password">
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Navigation Header (matches client portal login) -->
    <header class="header portal-header">
      <div class="container is--full">
        <nav class="nav-row">
          <a href="/" aria-label="no bhad codes - Go to homepage" class="nav-logo-row"> no bhad codes </a>
          <div class="nav-row__right">
            <!-- CLIENT PORTAL BUTTON -->
            <button class="portal-button" aria-label="Client Portal Login" id="portal-trigger">
              <div class="icon-wrap">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/>
                </svg>
              </div>
            </button>

            <button id="toggle-theme" class="theme-button" aria-label="Toggle dark/light theme">
              <div class="icon-wrap">
                <svg
                  class="theme-icon sun-icon"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                >
                  <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"></circle>
                  <path
                    d="M12 2V4M12 20V22M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
                    stroke="currentColor"
                    stroke-width="2"
                  ></path>
                </svg>
                <svg
                  class="theme-icon moon-icon"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  aria-hidden="true"
                >
                  <path d="M21 12.79A9 9 0 1 1 11.21 3A7 7 0 0 0 21 12.79z"></path>
                </svg>
              </div>
            </button>
            <button data-menu-toggle="" class="menu-button" aria-label="Toggle navigation menu" aria-expanded="false">
              <div class="icon-wrap">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="100%"
                  viewBox="0 0 16 16"
                  fill="none"
                  class="menu-button-icon"
                  aria-hidden="true"
                >
                  <path
                    d="M7.33333 16L7.33333 -3.2055e-07L8.66667 -3.78832e-07L8.66667 16L7.33333 16Z"
                    fill="currentColor"
                  ></path>
                  <path
                    d="M16 8.66667L-2.62269e-07 8.66667L-3.78832e-07 7.33333L16 7.33333L16 8.66667Z"
                    fill="currentColor"
                  ></path>
                  <path
                    d="M6 7.33333L7.33333 7.33333L7.33333 6C7.33333 6.73637 6.73638 7.33333 6 7.33333Z"
                    fill="currentColor"
                  ></path>
                  <path
                    d="M10 7.33333L8.66667 7.33333L8.66667 6C8.66667 6.73638 9.26362 7.33333 10 7.33333Z"
                    fill="currentColor"
                  ></path>
                  <path
                    d="M6 8.66667L7.33333 8.66667L7.33333 10C7.33333 9.26362 6.73638 8.66667 6 8.66667Z"
                    fill="currentColor"
                  ></path>
                  <path
                    d="M10 8.66667L8.66667 8.66667L8.66667 10C8.66667 9.26362 9.26362 8.66667 10 8.66667Z"
                    fill="currentColor"
                  ></path>
                </svg>
              </div>
              <div class="menu-button-text">
                <p class="p-large">Menu</p>
                <p class="p-large">Close</p>
              </div>
            </button>
          </div>
        </nav>
      </div>
    </header>

    <!-- Reset Password Container -->
    <div class="set-password-page" id="main-content">
      <div class="set-password-container">
        <div class="set-password-card">
          <div class="set-password-header">
            <a href="/" class="set-password-logo">
              <img src="/images/avatar.svg" alt="No Bhad Codes" class="set-password-logo-img" />
            </a>
            <h1>Reset Password</h1>
            <p class="set-password-subtitle" id="welcome-message">Enter your new password below.</p>
          </div>

          <!-- Loading State -->
          <div id="loading-state" class="set-password-loading" style="display: none">
            <p>Validating reset link...</p>
          </div>

          <!-- Error State -->
          <div id="error-state" class="set-password-error" style="display: none">
            <div class="error-icon">!</div>
            <h2>Invalid or Expired Link</h2>
            <p id="error-message">This password reset link is no longer valid.</p>
            <a href="/client/forgot-password.html" class="btn btn-secondary">Request New Link</a>
          </div>

          <!-- Success State (after password reset) -->
          <div id="success-state" class="set-password-success" style="display: none">
            <div class="success-icon">&#10003;</div>
            <h2>Password Reset Successfully!</h2>
            <p>Your password has been updated. You can now log in with your new password.</p>
            <a href="/client/" class="btn btn-primary">Go to Login</a>
          </div>

          <!-- Reset Password Form -->
          <form id="reset-password-form" class="set-password-form" style="display: none" autocomplete="off">
            <div class="form-group">
              <label for="password" class="field-label">New Password</label>
              <div class="password-input-wrapper">
                <input
                  type="password"
                  id="password"
                  required
                  minlength="12"
                  class="form-input"
                  placeholder="12+ chars, upper, lower, number, special"
                  aria-describedby="password-requirements"
                  autocomplete="new-password"
                />
                <button
                  type="button"
                  class="password-toggle"
                  data-password-toggle="password"
                  aria-label="Show password"
                ></button>
              </div>
            </div>

            <div class="form-group">
              <label for="confirm-password" class="field-label">Confirm Password</label>
              <div class="password-input-wrapper">
                <input
                  type="password"
                  id="confirm-password"
                  required
                  minlength="12"
                  class="form-input"
                  placeholder="Confirm your password"
                  autocomplete="off"
                />
                <button
                  type="button"
                  class="password-toggle"
                  data-password-toggle="confirm-password"
                  aria-label="Show password"
                ></button>
              </div>
            </div>

            <!-- Password Requirements -->
            <div class="password-requirements" id="password-requirements">
              <p class="requirements-title">Password must contain:</p>
              <ul class="requirements-list">
                <li id="req-length" class="requirement">At least 12 characters</li>
                <li id="req-uppercase" class="requirement">One uppercase letter</li>
                <li id="req-lowercase" class="requirement">One lowercase letter</li>
                <li id="req-number" class="requirement">One number</li>
                <li id="req-special" class="requirement">One special character (@$!%*?&-)</li>
              </ul>
            </div>

            <div id="form-error" class="form-error" style="display: none"></div>

            <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
              Reset Password
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer (matches client portal login) -->
    <footer class="footer portal-footer">
      <div class="footer-content">
        <p>&copy; <span id="copyright-year"></span> No Bhad Codes. All rights reserved.</p>
      </div>
    </footer>

    <script>
      document.getElementById('copyright-year').textContent = new Date().getFullYear();
    </script>

    <script type="module">
      // Import password toggle component
      import { initAllPasswordToggles } from '/src/components/password-toggle.ts';

      // Reset Password Page Logic
      document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');

        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const successState = document.getElementById('success-state');
        const formElement = document.getElementById('reset-password-form');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const formError = document.getElementById('form-error');
        const submitBtn = document.getElementById('submit-btn');
        const errorMessage = document.getElementById('error-message');

        // Password requirement elements
        const reqLength = document.getElementById('req-length');
        const reqUppercase = document.getElementById('req-uppercase');
        const reqLowercase = document.getElementById('req-lowercase');
        const reqNumber = document.getElementById('req-number');
        const reqSpecial = document.getElementById('req-special');

        if (!token) {
          errorState.style.display = 'block';
          errorMessage.textContent =
            'No reset token provided. Please use the link from your password reset email.';
          return;
        }

        // Show form immediately (token validation happens on submit)
        formElement.style.display = 'block';

        // Initialize password toggles after form is shown
        console.log('[ResetPassword] Initializing password toggles...');
        initAllPasswordToggles();

        // Real-time password validation
        function validatePassword(password) {
          const results = {
            length: password.length >= 12,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[@$!%*?&\-]/.test(password)
          };

          // Update UI
          reqLength.classList.toggle('valid', results.length);
          reqUppercase.classList.toggle('valid', results.uppercase);
          reqLowercase.classList.toggle('valid', results.lowercase);
          reqNumber.classList.toggle('valid', results.number);
          reqSpecial.classList.toggle('valid', results.special);

          return Object.values(results).every(Boolean);
        }

        // Listen for password input to validate in real-time
        passwordInput.addEventListener('input', () => {
          validatePassword(passwordInput.value);
        });

        // Handle form submission
        formElement.addEventListener('submit', async (e) => {
          e.preventDefault();
          formError.style.display = 'none';

          const password = passwordInput.value;
          const confirmPassword = confirmPasswordInput.value;

          if (password !== confirmPassword) {
            formError.textContent = 'Passwords do not match.';
            formError.style.display = 'block';
            return;
          }

          // Validate password requirements
          if (!validatePassword(password)) {
            formError.textContent = 'Password does not meet all requirements.';
            formError.style.display = 'block';
            return;
          }

          submitBtn.disabled = true;
          submitBtn.textContent = 'Resetting Password...';

          try {
            const response = await fetch('/api/auth/reset-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token, password }),
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
              formError.textContent = data.error || 'Failed to reset password. Please try again.';
              formError.style.display = 'block';
              submitBtn.disabled = false;
              submitBtn.textContent = 'Reset Password';

              // If token is invalid/expired, show error state
              if (data.code === 'INVALID_TOKEN' || data.code === 'TOKEN_EXPIRED') {
                formElement.style.display = 'none';
                errorState.style.display = 'block';
                errorMessage.textContent = data.error || 'This password reset link is no longer valid.';
              }
              return;
            }

            // Success!
            formElement.style.display = 'none';
            successState.style.display = 'block';
          } catch (err) {
            formError.textContent = 'An error occurred. Please try again later.';
            formError.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Reset Password';
          }
        });
      });
    </script>

    <style>
      /* Password requirements styling */
      .password-requirements {
        margin-top: var(--space-2, 8px);
        padding: var(--space-3, 12px);
        background: var(--portal-bg-medium, #f5f5f5);
        border-radius: var(--portal-radius-sm, 4px);
        font-size: var(--font-size-sm, 13px);
      }

      .requirements-title {
        margin: 0 0 var(--space-2, 8px) 0;
        font-weight: var(--font-weight-medium, 500);
        color: var(--portal-text-secondary, #666);
      }

      .requirements-list {
        margin: 0;
        padding-left: var(--space-4, 16px);
        list-style: none;
      }

      .requirement {
        position: relative;
        padding-left: var(--space-3, 12px);
        margin-bottom: var(--space-1, 4px);
        color: var(--portal-text-muted, #999);
        transition: color 0.2s ease;
      }

      .requirement::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--portal-text-muted, #999);
        transition: background 0.2s ease;
      }

      .requirement.valid {
        color: var(--color-success-500, #22c55e);
      }

      .requirement.valid::before {
        background: var(--color-success-500, #22c55e);
      }

      /* Dark mode support */
      [data-theme="dark"] .password-requirements {
        background: var(--portal-bg-darker, #2a2a2a);
      }

      [data-theme="dark"] .requirements-title {
        color: var(--portal-text-light, #e0e0e0);
      }

      .set-password-footer {
        text-align: center;
        margin-top: var(--space-4, 16px);
      }

      .set-password-footer .auth-link {
        color: var(--color-primary, #0070f3);
        text-decoration: none;
        font-size: var(--font-size-sm, 13px);
      }

      .set-password-footer .auth-link:hover {
        text-decoration: underline;
      }
    </style>
  </body>
</html>
