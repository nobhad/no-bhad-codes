<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Set Your Password - No Bhad Codes Client Portal</title>
    <style>
      :root {
        --bg: #ffffff;
        --fg: #000000;
      }
      [data-theme='dark'] {
        --bg: #1a1a1a;
        --fg: #ffffff;
      }
      html,
      body {
        background-color: var(--bg);
        color: var(--fg);
        margin: 0;
        padding: 0;
      }
    </style>
    <script>
      (function () {
        try {
          const savedTheme = localStorage.getItem('theme');
          document.documentElement.setAttribute('data-theme', savedTheme || 'light');
        } catch (e) {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      })();
    </script>
    <meta name="description" content="Set your password for the No Bhad Codes Client Portal" />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#e0e0e0" />
    <script type="module" src="/src/portal.ts"></script>
  </head>
  <body data-page="set-password">
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Set Password Container -->
    <div class="set-password-page" id="main-content">
      <div class="set-password-container">
        <div class="set-password-card">
          <div class="set-password-header">
            <a href="/" class="set-password-logo">
              <img src="/images/avatar.svg" alt="No Bhad Codes" class="set-password-logo-img" />
            </a>
            <h1>Set Your Password</h1>
            <p class="set-password-subtitle" id="welcome-message">Welcome to the Client Portal</p>
          </div>

          <!-- Loading State -->
          <div id="loading-state" class="set-password-loading">
            <p>Verifying your invitation...</p>
          </div>

          <!-- Error State -->
          <div id="error-state" class="set-password-error" style="display: none">
            <div class="error-icon">!</div>
            <h2>Invalid or Expired Link</h2>
            <p id="error-message">This invitation link is no longer valid.</p>
            <a href="/" class="btn btn-secondary">Go to Login</a>
          </div>

          <!-- Success State (after password set) -->
          <div id="success-state" class="set-password-success" style="display: none">
            <div class="success-icon">&#10003;</div>
            <h2>Password Set Successfully!</h2>
            <p>Your account is now active. You can log in to your client portal.</p>
            <a href="/" class="btn btn-primary">Go to Login</a>
          </div>

          <!-- Set Password Form -->
          <form id="set-password-form" class="set-password-form" style="display: none">
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" readonly class="form-input" />
            </div>

            <div class="form-group">
              <label for="password">New Password</label>
              <div class="password-input-wrapper">
                <input
                  type="password"
                  id="password"
                  required
                  minlength="8"
                  class="form-input"
                  placeholder="At least 8 characters"
                  aria-describedby="password-requirements"
                />
                <button
                  type="button"
                  class="password-toggle"
                  data-password-toggle="password"
                  aria-label="Show password"
                >
                </button>
              </div>
              <span id="password-requirements" class="field-hint">At least 8 characters</span>
            </div>

            <div class="form-group">
              <label for="confirm-password">Confirm Password</label>
              <div class="password-input-wrapper">
                <input
                  type="password"
                  id="confirm-password"
                  required
                  minlength="8"
                  class="form-input"
                  placeholder="Confirm your password"
                />
                <button
                  type="button"
                  class="password-toggle"
                  data-password-toggle="confirm-password"
                  aria-label="Show password"
                >
                </button>
              </div>
            </div>

            <div id="form-error" class="form-error" style="display: none"></div>

            <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
              Set Password & Activate Account
            </button>
          </form>
        </div>
      </div>
    </div>

    <script type="module">
      // Import password toggle component
      import { initAllPasswordToggles } from '/src/components/password-toggle.ts';

      // Set Password Page Logic
      document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');

        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const successState = document.getElementById('success-state');
        const formElement = document.getElementById('set-password-form');
        const welcomeMessage = document.getElementById('welcome-message');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const formError = document.getElementById('form-error');
        const submitBtn = document.getElementById('submit-btn');
        const errorMessage = document.getElementById('error-message');

        if (!token) {
          loadingState.style.display = 'none';
          errorState.style.display = 'block';
          errorMessage.textContent =
            'No invitation token provided. Please use the link from your invitation email.';
          return;
        }

        // Verify the token
        try {
          const response = await fetch('/api/auth/verify-invitation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token }),
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            errorMessage.textContent = data.error || 'Invalid invitation link.';
            return;
          }

          // Token is valid - show the form
          loadingState.style.display = 'none';
          formElement.style.display = 'block';
          emailInput.value = data.email;
          if (data.name) {
            welcomeMessage.textContent = `Welcome, ${data.name}! Create your password to access your client portal.`;
          }

          // Initialize password toggles after form is shown
          initAllPasswordToggles();
        } catch (err) {
          loadingState.style.display = 'none';
          errorState.style.display = 'block';
          errorMessage.textContent = 'Unable to verify invitation. Please try again later.';
          return;
        }

        // Handle form submission
        formElement.addEventListener('submit', async (e) => {
          e.preventDefault();
          formError.style.display = 'none';

          const password = passwordInput.value;
          const confirmPassword = confirmPasswordInput.value;

          if (password !== confirmPassword) {
            formError.textContent = 'Passwords do not match.';
            formError.style.display = 'block';
            return;
          }

          if (password.length < 8) {
            formError.textContent = 'Password must be at least 8 characters long.';
            formError.style.display = 'block';
            return;
          }

          submitBtn.disabled = true;
          submitBtn.textContent = 'Setting Password...';

          try {
            const response = await fetch('/api/auth/set-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token, password }),
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
              formError.textContent = data.error || 'Failed to set password. Please try again.';
              formError.style.display = 'block';
              submitBtn.disabled = false;
              submitBtn.textContent = 'Set Password & Activate Account';
              return;
            }

            // Success!
            formElement.style.display = 'none';
            successState.style.display = 'block';
          } catch (err) {
            formError.textContent = 'An error occurred. Please try again later.';
            formError.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Set Password & Activate Account';
          }
        });
      });
    </script>
  </body>
</html>
